//打开登录页
open 'https://login.aliexpress.com'
//输入用户名
//type '#fm-login-id' '你的用户名'
//输入密码
//type '#fm-login-password' '你的密码'
//3秒内等待滑动条出现
//wait '.nc_iconfont.btn_slide' visible 3
//then
    //滑动滑动条
//    drag '.nc_iconfont.btn_slide' '300,0'
    //等待3秒
//    sleep 3
//end
//点击登录按钮
//click '.fm-button'
//60秒内等待进入速卖通首页
wait 'https://www.aliexpress.com/' url 60
then
    //弹出提示
    alert '登录成功'
    //跳到商品页
    open 'https://www.aliexpress.com/item/33009391663.html?spm=a2g0o.new_user_benefits.floor_300000000436285.57.7b7c47afCtTaNx&gps-id=300000000436285'
    //3秒内等待弹窗出现
    wait '.poplayer-content' visible 3
    then
       //点击关闭弹出
        click '.btn-close'
    end
    //赋值sku
    set sku
    <script>
        var list = [];
        document.querySelectorAll(".sku-property-item img").forEach(item=>{
           list.push({sku:item.title.trim()});
        })
        return list;
    </script>

    //滚动到指定位置，为了加载iframe
    scroll 0,1413
    //等待3秒
    sleep 3
    //切进iframe
    switch 'product-evaluation'
    set next
    <script>
        return true;
    </script>
    repeat
    <script>
        return arguments[0]['next'];
    </script>
    begin
        set comment
        <script>
            var list = arguments[0]['comment'] || [];
            document.querySelectorAll(".feedback-item").forEach(item=>{
                list.push({
                    country: item.querySelector(".user-country").innerText,
                    star: item.querySelector(".star-view span").style.width.replace('%','')/20,
                    sku: item.querySelector(".user-order-info .first").innerText.replace(item.querySelector(".user-order-info .first strong").innerText,'')
                });
            });
            return list;
        </script>

        //点击下一页
        set next
        <script>
            if(document.querySelector(".ui-pagination-next.ui-goto-page")){
                document.querySelector(".ui-pagination-next.ui-goto-page").click();
                return true;
            }else{
                return false;
            }
        </script>
        //等待2秒
        sleep 2
    end
    set result
    <script>
        var comments = arguments[0]['comment'];
        var sku = arguments[0]['sku'];
        var group  = {};
        for(var i =0;i<comments.length;i++){
            var country = comments[i]['country'];
            if(Object.keys(group).indexOf(country)>-1){
                group[country].push(comments[i]);
            }else{
                group[country] = [comments[i]];
            }
        }
        var result = [];
        for(var i = 0;i<Object.keys(group).length;i++){
            var country = Object.keys(group)[i];
            for(var j =0;j<sku.length;j++){
                var temp = group[country].filter(m=>m.sku.replace(/\s+/g," ").trim()==sku[j].sku.replace(/\s+/g," ").trim());
                var sum = temp.length;
                var item = {
                    "国家":country,
                    SKU: sku[j].sku,
                    "5星数量":temp.filter(m=> m.star == 5).length,
                    "4星数量":temp.filter(m=> m.star == 4).length,
                    "3星数量":temp.filter(m=> m.star == 3).length,
                    "2星数量":temp.filter(m=> m.star == 2).length,
                    "1星数量":temp.filter(m=> m.star == 1).length,
                    "合计": sum,
                    "占比":(sum/comments.length)*100+'%',
                };
                result.push(item);
            }
        }
        return result;
    </script>
    saveCsv result result.csv
else
    //弹出提示
    alert '60秒内未登录成功，请重新启动脚本'
end